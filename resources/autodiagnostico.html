<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisador ENEM</title>
    <script src="https://neutralino.js.org/js/neutralino.js"></script>
    <style>
        /* SEUS ESTILOS ORIGINAIS - MANTIDOS */
        :root {
            --primary-color: #2CC985;
            --secondary-color: #4a6fa5;
            --background-color: #f5f5f5;
            --card-color: #ffffff;
            --text-color: #333333;
            --border-color: #dddddd;
            --error-color: #ff4444;
            --warning-color: #ffaa00;
            --success-color: #00aa44;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
            position: relative;
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        h2 {
            color: var(--secondary-color);
            margin-bottom: 15px;
        }

        .back-button {
            position: absolute;
            left: 0;
            top: 0;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .back-button:hover {
            background-color: #3d5c8a;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            background-color: var(--background-color);
        }

        .tab.active {
            background-color: var(--card-color);
            border-color: var(--border-color);
            font-weight: bold;
        }

        .tab-content {
            display: none;
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 0 5px 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #25b074;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: #3d5c8a;
        }

        .btn-danger {
            background-color: var(--error-color);
        }

        .btn-danger:hover {
            background-color: #dd3333;
        }

        .chart-container {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--card-color);
        }

        .chart-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-wrapper {
            flex: 1;
            position: relative;
            height: 300px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f0f0f0;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        tr.selected {
            background-color: #e6f3ff;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .tooltip {
            position: absolute;
            background-color: #ffffe0;
            border: 1px solid #cccccc;
            padding: 5px 10px;
            border-radius: 4px;
            max-width: 400px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none;
        }

        .scrollable {
            max-height: 500px;
            overflow-y: auto;
        }

        .subject-chart {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }

        .subject-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--secondary-color);
        }

        .chart-canvas-container {
            position: relative;
            height: 400px;
        }

        /* Estilos para o modal de edi√ß√£o */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
        }

        .modal-content {
            padding: 20px;
        }

        .edit-btn {
            background-color: var(--secondary-color);
            padding: 5px 10px;
            font-size: 12px;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
            display: none;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .chart-row {
                flex-direction: column;
            }
            
            .chart-wrapper {
                height: 250px;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <a href="index.html" class="back-button">‚Üê Voltar ao Calend√°rio</a>
            <h1>Analisador ENEM</h1>
        </header>

        <div id="statusMessage" class="status-message"></div>

        <div class="tabs">
            <div class="tab active" data-tab="register">Cadastrar</div>
            <div class="tab" data-tab="charts">Gr√°ficos</div>
            <div class="tab" data-tab="subtopics">Subt√≥picos</div>
            <div class="tab" data-tab="data">Planilha</div>
        </div>
        <div id="register" class="tab-content active">
            <h2>Cadastrar Quest√£o</h2>
            <form id="question-form">
                <div class="form-group">
                    <label for="subject">Mat√©ria:</label>
                    <select id="subject" required>
                        <option value="">Selecione uma mat√©ria</option>
                        <option value="F√≠sica">F√≠sica</option>
                        <option value="Matem√°tica">Matem√°tica</option>
                        <option value="Biologia">Biologia</option>
                        <option value="Qu√≠mica">Qu√≠mica</option>
                        <option value="Hist√≥ria">Hist√≥ria</option>
                        <option value="Geografia">Geografia</option>
                        <option value="Filosofia">Filosofia</option>
                        <option value="Sociologia">Sociologia</option>
                        <option value="Artes">Artes</option>
                        <option value="Literatura">Literatura</option>
                        <option value="Portugu√™s">Portugu√™s</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="topic">T√≥pico:</label>
                    <input type="text" id="topic" required>
                </div>

                <div class="form-group">
                    <label for="subtopic">Subt√≥pico:</label>
                    <input type="text" id="subtopic">
                </div>

                <div class="form-group">
                    <label for="description">Descri√ß√£o:</label>
                    <textarea id="description"></textarea>
                </div>

                <div class="form-group">
                    <label>Errou por falta de:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="content-error">
                            <label for="content-error">Conte√∫do</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="attention-error">
                            <label for="attention-error">Aten√ß√£o</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="time-error">
                            <label for="time-error">Tempo</label>
                        </div>
                    </div>
                </div>

                <button type="submit">Adicionar</button>
            </form>
        </div>
        <div id="charts" class="tab-content">
            <h2>Gr√°ficos</h2>
            
            <div class="chart-row">
                <div class="chart-container">
                    <h3>Distribui√ß√£o por Mat√©ria</h3>
                    <div class="chart-wrapper">
                        <canvas id="pie-chart"></canvas>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h3>Contagem por Mat√©ria</h3>
                    <div class="table-container">
                        <table id="count-table">
                            <thead>
                                <tr>
                                    <th>Mat√©ria</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody id="count-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="bar-charts-container">
                
            </div>
        </div>
        <div id="subtopics" class="tab-content">
            <h2>Subt√≥picos</h2>
            <div id="subtopics-container" class="scrollable">
               
            </div>
        </div>

       
        <div id="data" class="tab-content">
            <h2>Planilha de Dados</h2>
            <div class="table-container scrollable">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th>Mat√©ria</th>
                            <th>T√≥pico</th>
                            <th>Subt√≥pico</th>
                            <th>Descri√ß√£o</th>
                            <th>Erro</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                    
                    </tbody>
                </table>
            </div>
            
            <div class="action-buttons">
                <button id="import-csv" class="btn-secondary">Importar CSV</button>
                <button id="export-csv" class="btn-secondary">Exportar CSV</button>
                <button id="delete-selected" class="btn-danger">Excluir Selecionados</button>
            </div>
            
            <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
        </div>
    </div>
    <div id="tooltip" class="tooltip hidden"></div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>  
        const colors = [
            "#FF9999", "#66B3FF", "#99FF99", "#FFCC99", "#C2C2F0",
            "#FFB3E6", "#FFFF99", "#FF6666", "#66FFCC", "#FF99CC", "#66FF66"
        ];

        // SISTEMA DE PERSIST√äNCIA DIRETO - IGUAL AO CALEND√ÅRIO
        class ENEMStorage {
            constructor() {
                this.storageKey = 'enem_questions';
                this.storagePath = '.storage/enem_questions.json';
                this.isNeutralino = false;
            }

            async init() {
                try {
                    if (typeof Neutralino !== 'undefined') {
                        await Neutralino.init();
                        this.isNeutralino = true;
                        console.log('üíæ Modo Neutralino Filesystem');
                    } else {
                        console.log('üíæ Modo LocalStorage (Navegador)');
                    }
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro na inicializa√ß√£o:', error);
                    this.isNeutralino = false;
                    return false;
                }
            }

            async saveData(data) {
                try {
                    if (this.isNeutralino) {
                        // SALVAR EM ARQUIVO - m√©todo direto e simples
                        await Neutralino.filesystem.writeFile(this.storagePath, JSON.stringify(data));
                        console.log('üíæ Dados salvos em:', this.storagePath);
                        return true;
                    } else {
                        localStorage.setItem(this.storageKey, JSON.stringify(data));
                        return true;
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao salvar:', error);
                    // Fallback para localStorage
                    try {
                        localStorage.setItem(this.storageKey, JSON.stringify(data));
                        return true;
                    } catch (e) {
                        return false;
                    }
                }
            }

            async loadData() {
                try {
                    if (this.isNeutralino) {
                        try {
                            // TENTAR LER DO ARQUIVO
                            const fileContent = await Neutralino.filesystem.readFile(this.storagePath);
                            const data = JSON.parse(fileContent);
                            console.log('üì• Dados carregados do arquivo');
                            return data;
                        } catch (fileError) {
                            console.log('üìÑ Arquivo n√£o existe, criando vazio...');
                            // Se o arquivo n√£o existe, criar um array vazio
                            await this.saveData([]);
                            return [];
                        }
                    } else {
                        const localData = localStorage.getItem(this.storageKey);
                        return localData ? JSON.parse(localData) : [];
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar:', error);
                    return [];
                }
            }
        }

        class ENEMAnalyzer {
            constructor() {
                this.questions = [];
                this.subjects = [
                    "F√≠sica", "Matem√°tica", "Biologia", "Qu√≠mica", 
                    "Hist√≥ria", "Geografia", "Filosofia", "Sociologia", 
                    "Artes", "Literatura", "Portugu√™s"
                ];
                this.charts = {};
                this.storage = new ENEMStorage();
                
                this.init();
            }

            async init() {
                console.log('üöÄ INICIANDO ANALISADOR ENEM');
                
                // Inicializar storage
                await this.storage.init();
                
                // Carregar dados
                await this.loadData();
                
                // Configurar interface
                this.setupEventListeners();
                this.updateAllViews();
                
                console.log(`‚úÖ Analisador ENEM inicializado com ${this.questions.length} quest√µes`);
            }

            async loadData() {
                try {
                    this.questions = await this.storage.loadData();
                    console.log(`‚úÖ ${this.questions.length} quest√µes carregadas`);
                } catch (error) {
                    console.error('‚ùå Erro ao carregar dados:', error);
                    this.questions = [];
                    this.showStatus('‚ùå Erro ao carregar dados!', 'error');
                }
            }

            async saveData() {
                try {
                    const success = await this.storage.saveData(this.questions);
                    if (success) {
                        console.log('üíæ Dados salvos com sucesso');
                        return true;
                    } else {
                        throw new Error('Falha no salvamento');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao salvar dados:', error);
                    this.showStatus('‚ùå Erro ao salvar dados!', 'error');
                    return false;
                }
            }

            async saveQuestion(question) {
                try {
                    // Gerar ID √∫nico
                    if (!question.id) {
                        question.id = 'q_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    }
                    
                    // Garantir timestamp
                    if (!question.timestamp) {
                        question.timestamp = new Date().toISOString();
                    }
                    
                    // Adicionar √† lista
                    this.questions.push(question);
                    
                    // Salvar todos os dados
                    const success = await this.saveData();
                    
                    if (success) {
                        this.showStatus('‚úÖ Quest√£o salva com sucesso!', 'success');
                        return true;
                    } else {
                        throw new Error('Falha no salvamento');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao salvar quest√£o:', error);
                    this.showStatus('‚ùå Erro ao salvar quest√£o!', 'error');
                    // Remover da lista em caso de erro
                    this.questions = this.questions.filter(q => q.id !== question.id);
                    return false;
                }
            }

            async updateQuestion(id, updatedQuestion) {
                try {
                    const index = this.questions.findIndex(q => q.id === id);
                    if (index !== -1) {
                        // Manter ID e timestamp originais
                        updatedQuestion.id = id;
                        updatedQuestion.timestamp = this.questions[index].timestamp;
                        
                        this.questions[index] = updatedQuestion;
                        
                        const success = await this.saveData();
                        if (success) {
                            this.showStatus('‚úÖ Quest√£o atualizada com sucesso!', 'success');
                            return true;
                        }
                    }
                    return false;
                } catch (error) {
                    console.error('‚ùå Erro ao atualizar quest√£o:', error);
                    this.showStatus('‚ùå Erro ao atualizar quest√£o!', 'error');
                    return false;
                }
            }

            async deleteQuestions(ids) {
                try {
                    const initialLength = this.questions.length;
                    this.questions = this.questions.filter(q => !ids.includes(q.id));
                    
                    const success = await this.saveData();
                    if (success) {
                        const deletedCount = initialLength - this.questions.length;
                        this.showStatus(`‚úÖ ${deletedCount} quest√£o(√µes) exclu√≠da(s) com sucesso!`, 'success');
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('‚ùå Erro ao excluir quest√µes:', error);
                    this.showStatus('‚ùå Erro ao excluir quest√µes!', 'error');
                    return false;
                }
            }

            showStatus(message, type) {
                const statusElement = document.getElementById('statusMessage');
                statusElement.textContent = message;
                statusElement.className = `status-message status-${type}`;
                statusElement.style.display = 'block';
                
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 4000);
            }

            setupEventListeners() {
                // Tabs
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        this.switchTab(tab.dataset.tab);
                    });
                });

                // Formul√°rio
                document.getElementById('question-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await this.handleSaveQuestion();
                });

                // Import/Export
                document.getElementById('import-csv').addEventListener('click', () => {
                    document.getElementById('csv-file-input').click();
                });

                document.getElementById('csv-file-input').addEventListener('change', (e) => {
                    this.importCSV(e.target.files[0]);
                    e.target.value = ''; 
                });

                document.getElementById('export-csv').addEventListener('click', () => {
                    this.exportCSV();
                });

                document.getElementById('delete-selected').addEventListener('click', async () => {
                    await this.deleteSelected();
                });

                // Tooltip
                document.getElementById('data-table').addEventListener('mouseover', (e) => {
                    if (e.target.tagName === 'TD' && e.target.cellIndex === 3) {
                        const fullText = e.target.dataset.fullText;
                        if (fullText && fullText.length > 50) {
                            this.showTooltip(e, fullText);
                        }
                    }
                });

                document.getElementById('data-table').addEventListener('mouseout', () => {
                    this.hideTooltip();
                });
                
                // Sele√ß√£o de linhas
                document.getElementById('data-table').addEventListener('click', (e) => {
                    const row = e.target.closest('tr');
                    if (row && row.dataset.id !== undefined && !e.target.classList.contains('edit-btn')) {
                        row.classList.toggle('selected');
                    }
                });
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });

                document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
                document.getElementById(tabName).classList.add('active');

                if (tabName === 'charts') {
                    this.updateCharts();
                } else if (tabName === 'subtopics') {
                    this.updateSubtopicsCharts();
                } else if (tabName === 'data') {
                    this.updateDataView();
                }
            }

            async handleSaveQuestion() {
                const subject = document.getElementById('subject').value;
                const topic = document.getElementById('topic').value;
                
                if (!subject || !topic) {
                    this.showStatus("Preencha pelo menos Mat√©ria e T√≥pico!", "error");
                    return;
                }

                const newQuestion = {
                    subject: subject.trim(),
                    topic: topic.trim(),
                    subtopic: document.getElementById('subtopic').value.trim(),
                    description: document.getElementById('description').value.trim(),
                    erros: {
                        conteudo: document.getElementById('content-error').checked,
                        atencao: document.getElementById('attention-error').checked,
                        tempo: document.getElementById('time-error').checked
                    }
                };

                console.log('‚ûï Adicionando nova quest√£o:', newQuestion);
                
                const saved = await this.saveQuestion(newQuestion);
                if (saved) {
                    this.clearForm();
                    this.updateAllViews();
                }
            }

            clearForm() {
                document.getElementById('question-form').reset();
            }

            updateAllViews() {
                this.updateCharts();
                this.updateSubtopicsCharts();
                this.updateDataView();
            }

            // ... (mantenha todos os outros m√©todos de updateCharts, updatePieChart, etc. iguais)

            updateCharts() {
                this.updatePieChart();
                this.updateCountTable();
                this.updateBarCharts();
            }

            updatePieChart() {
                const counts = {};
                this.questions.forEach(q => {
                    counts[q.subject] = (counts[q.subject] || 0) + 1;
                });

                const ctx = document.getElementById('pie-chart');
                
                if (this.charts.pie) {
                    this.charts.pie.destroy();
                }

                if (Object.keys(counts).length === 0) {
                    ctx.innerHTML = '<p style="text-align: center; padding: 50px;">Nenhum dado dispon√≠vel</p>';
                    return;
                }

                const labels = Object.keys(counts);
                const data = Object.values(counts);

                this.charts.pie = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            updateCountTable() {
                const counts = {};
                this.questions.forEach(q => {
                    counts[q.subject] = (counts[q.subject] || 0) + 1;
                });

                const tbody = document.getElementById('count-table-body');
                tbody.innerHTML = '';

                const sortedCounts = Object.entries(counts)
                    .sort((a, b) => b[1] - a[1]);

                sortedCounts.forEach(([subject, count]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${subject}</td>
                        <td>${count}</td>
                    `;
                    tbody.appendChild(row);
                });

                if (sortedCounts.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="2" style="text-align: center;">Nenhum dado dispon√≠vel</td>';
                    tbody.appendChild(row);
                }
            }

            updateBarCharts() {
                const container = document.getElementById('bar-charts-container');
                container.innerHTML = '';

                const subjectTopics = {};
                this.questions.forEach(q => {
                    if (!subjectTopics[q.subject]) {
                        subjectTopics[q.subject] = {};
                    }
                    subjectTopics[q.subject][q.topic] = (subjectTopics[q.subject][q.topic] || 0) + 1;
                });

                if (Object.keys(subjectTopics).length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum dado dispon√≠vel</p>';
                    return;
                }

                Object.keys(subjectTopics).forEach(subject => {
                    const topics = subjectTopics[subject];
                    const sortedTopics = Object.entries(topics)
                        .sort((a, b) => b[1] - a[1]);

                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'subject-chart';
                    subjectDiv.innerHTML = `
                        <div class="subject-title">T√≥picos de ${subject}</div>
                        <div class="chart-canvas-container">
                            <canvas id="chart-${subject.replace(/\s+/g, '-')}"></canvas>
                        </div>
                    `;
                    container.appendChild(subjectDiv);

                    const ctx = document.getElementById(`chart-${subject.replace(/\s+/g, '-')}`);
                    const labels = sortedTopics.map(t => t[0]);
                    const data = sortedTopics.map(t => t[1]);

                    if (this.charts[`bar-${subject}`]) {
                        this.charts[`bar-${subject}`].destroy();
                    }

                    this.charts[`bar-${subject}`] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Quantidade',
                                data: data,
                                backgroundColor: '#4a6fa5',
                                borderWidth: 1,
                                barPercentage: 0.6,
                                categoryPercentage: 0.8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        precision: 0
                                    },
                                    grid: {
                                        display: true
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 0
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            layout: {
                                padding: {
                                    top: 20
                                }
                            }
                        }
                    });
                });
            }

            updateSubtopicsCharts() {
                const container = document.getElementById('subtopics-container');
                container.innerHTML = '';

                const subjectSubtopics = {};
                this.questions.forEach(q => {
                    if (!subjectSubtopics[q.subject]) {
                        subjectSubtopics[q.subject] = {};
                    }
                    const subtopic = q.subtopic || "Sem subt√≥pico";
                    subjectSubtopics[q.subject][subtopic] = (subjectSubtopics[q.subject][subtopic] || 0) + 1;
                });

                if (Object.keys(subjectSubtopics).length === 0) {
                    container.innerHTML = '<p style="text-align: center; padding: 20px;">Nenhum dado dispon√≠vel</p>';
                    return;
                }

                Object.keys(subjectSubtopics).forEach(subject => {
                    const subtopics = subjectSubtopics[subject];
                    const sortedSubtopics = Object.entries(subtopics)
                        .sort((a, b) => b[1] - a[1]);

                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'subject-chart';
                    subjectDiv.innerHTML = `
                        <div class="subject-title">Subt√≥picos de ${subject}</div>
                        <div class="chart-canvas-container">
                            <canvas id="subtopic-chart-${subject.replace(/\s+/g, '-')}"></canvas>
                        </div>
                    `;
                    container.appendChild(subjectDiv);

                    const ctx = document.getElementById(`subtopic-chart-${subject.replace(/\s+/g, '-')}`);
                    const labels = sortedSubtopics.map(t => t[0]);
                    const data = sortedSubtopics.map(t => t[1]);

                    if (this.charts[`subtopic-${subject}`]) {
                        this.charts[`subtopic-${subject}`].destroy();
                    }

                    this.charts[`subtopic-${subject}`] = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Quantidade',
                                data: data,
                                backgroundColor: '#4a6fa5',
                                borderWidth: 1,
                                barPercentage: 0.6,
                                categoryPercentage: 0.8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1,
                                        precision: 0
                                    },
                                    grid: {
                                        display: true
                                    }
                                },
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 0
                                    },
                                    grid: {
                                        display: false
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            layout: {
                                padding: {
                                    top: 20
                                }
                            }
                        }
                    });
                });
            }

            updateDataView() {
                const tbody = document.getElementById('data-table-body');
                tbody.innerHTML = '';

                this.questions.forEach((q) => {
                    const erros = q.erros || {};
                    const erroStr = Object.keys(erros)
                        .filter(tipo => erros[tipo])
                        .map(tipo => tipo.charAt(0).toUpperCase() + tipo.slice(1))
                        .join(', ');

                    const row = document.createElement('tr');
                    row.dataset.id = q.id;
                    row.innerHTML = `
                        <td>${q.subject}</td>
                        <td>${q.topic}</td>
                        <td>${q.subtopic || ''}</td>
                        <td data-full-text="${q.description.replace(/"/g, '&quot;')}">
                            ${q.description && q.description.length > 50 ? q.description.substring(0, 50) + '...' : (q.description || '')}
                        </td>
                        <td>${erroStr}</td>
                        <td>
                            <button class="edit-btn" data-id="${q.id}">Editar</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                if (this.questions.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = '<td colspan="6" style="text-align: center;">Nenhum dado dispon√≠vel</td>';
                    tbody.appendChild(row);
                }
                this.setupEditButtons();
            }

            setupEditButtons() {
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = btn.dataset.id;
                        this.openEditModal(id);
                    });
                });
            }

            openEditModal(id) {
                const question = this.questions.find(q => q.id === id);
                if (!question) return;
                
                const modalContent = `
                    <div class="form-group">
                        <label for="edit-subject">Mat√©ria:</label>
                        <select id="edit-subject" required>
                            <option value="">Selecione uma mat√©ria</option>
                            ${this.subjects.map(subject => 
                                `<option value="${subject}" ${subject === question.subject ? 'selected' : ''}>${subject}</option>`
                            ).join('')}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="edit-topic">T√≥pico:</label>
                        <input type="text" id="edit-topic" value="${question.topic}" required>
                    </div>

                    <div class="form-group">
                        <label for="edit-subtopic">Subt√≥pico:</label>
                        <input type="text" id="edit-subtopic" value="${question.subtopic || ''}">
                    </div>

                    <div class="form-group">
                        <label for="edit-description">Descri√ß√£o:</label>
                        <textarea id="edit-description">${question.description || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label>Errou por falta de:</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="edit-content-error" ${question.erros.conteudo ? 'checked' : ''}>
                                <label for="edit-content-error">Conte√∫do</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="edit-attention-error" ${question.erros.atencao ? 'checked' : ''}>
                                <label for="edit-attention-error">Aten√ß√£o</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="edit-time-error" ${question.erros.tempo ? 'checked' : ''}>
                                <label for="edit-time-error">Tempo</label>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button type="button" id="save-edit-btn">Salvar</button>
                        <button type="button" id="cancel-edit-btn" class="btn-secondary">Cancelar</button>
                    </div>
                `;

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>Editar Quest√£o</h3>
                            <button id="close-edit-modal">‚úï</button>
                        </div>
                        <div class="modal-content">
                            ${modalContent}
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                const closeModal = () => {
                    document.body.removeChild(modal);
                };

                modal.querySelector('#close-edit-modal').addEventListener('click', closeModal);
                modal.querySelector('#cancel-edit-btn').addEventListener('click', closeModal);
                
                modal.querySelector('#save-edit-btn').addEventListener('click', async () => {
                    await this.saveEdit(id, modal);
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            }

            async saveEdit(id, modal) {
                const subject = modal.querySelector('#edit-subject').value;
                const topic = modal.querySelector('#edit-topic').value;
                
                if (!subject || !topic) {
                    this.showStatus("Preencha pelo menos Mat√©ria e T√≥pico!", "error");
                    return;
                }

                const updatedQuestion = {
                    subject: subject.trim(),
                    topic: topic.trim(),
                    subtopic: modal.querySelector('#edit-subtopic').value.trim(),
                    description: modal.querySelector('#edit-description').value.trim(),
                    erros: {
                        conteudo: modal.querySelector('#edit-content-error').checked,
                        atencao: modal.querySelector('#edit-attention-error').checked,
                        tempo: modal.querySelector('#edit-time-error').checked
                    }
                };

                const saved = await this.updateQuestion(id, updatedQuestion);
                if (saved) {
                    document.body.removeChild(modal);
                    this.updateAllViews();
                }
            }

            showTooltip(event, text) {
                const tooltip = document.getElementById('tooltip');
                tooltip.textContent = text;
                tooltip.style.left = `${event.pageX + 10}px`;
                tooltip.style.top = `${event.pageY + 10}px`;
                tooltip.classList.remove('hidden');
            }

            hideTooltip() {
                document.getElementById('tooltip').classList.add('hidden');
            }

            importCSV(file) {
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const csvText = e.target.result;
                    const lines = csvText.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        this.showStatus("Arquivo CSV vazio ou inv√°lido!", "error");
                        return;
                    }
                    
                    const headers = lines[0].split(',').map(h => h.trim());
                    
                    let importedCount = 0;
                    
                    for (let i = 1; i < lines.length; i++) {
                        if (!lines[i].trim()) continue;
                        
                        const values = lines[i].split(',').map(v => v.trim());
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index] || '';
                        });
                        
                        if (!row['Mat√©ria'] || !row['T√≥pico']) {
                            continue;
                        }
                        
                        const errosStr = (row['Erros'] || '').toLowerCase();
                        const errosDict = {
                            conteudo: errosStr.includes('conteudo') || errosStr.includes('conte√∫do') || errosStr.includes('content'),
                            atencao: errosStr.includes('atencao') || errosStr.includes('aten√ß√£o') || errosStr.includes('attention'),
                            tempo: errosStr.includes('tempo') || errosStr.includes('time')
                        };
                        
                        const question = {
                            subject: row['Mat√©ria'],
                            topic: row['T√≥pico'],
                            subtopic: row['Subt√≥pico'] || '',
                            description: row['Descri√ß√£o'] || '',
                            erros: errosDict
                        };
                        
                        if (await this.saveQuestion(question)) {
                            importedCount++;
                        }
                    }
                    
                    if (importedCount > 0) {
                        this.updateAllViews();
                        this.showStatus(`‚úÖ ${importedCount} quest√µes importadas com sucesso!`, "success");
                    } else {
                        this.showStatus("‚ùå Nenhuma quest√£o v√°lida encontrada no arquivo!", "error");
                    }
                };
                
                reader.onerror = () => {
                    this.showStatus("‚ùå Erro ao ler o arquivo!", "error");
                };
                
                reader.readAsText(file, 'UTF-8');
            }

            exportCSV() {
                if (this.questions.length === 0) {
                    this.showStatus("Nenhum dado para exportar!", "error");
                    return;
                }

                let csvContent = "Mat√©ria,T√≥pico,Subt√≥pico,Descri√ß√£o,Erros\n";
                
                this.questions.forEach(q => {
                    const errosStr = Object.keys(q.erros)
                        .filter(tipo => q.erros[tipo])
                        .join(', ');
                    
                    const row = [
                        q.subject,
                        q.topic,
                        q.subtopic || '',
                        `"${(q.description || '').replace(/"/g, '""')}"`,
                        errosStr || 'Nenhum'
                    ];
                    
                    csvContent += row.join(',') + '\n';
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `enem_data_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                this.showStatus("‚úÖ CSV exportado com sucesso!", "success");
            }

            async deleteSelected() {
                const selectedRows = document.querySelectorAll('#data-table-body tr.selected');
                if (selectedRows.length === 0) {
                    this.showStatus("Selecione pelo menos uma linha para excluir!", "error");
                    return;
                }
                
                if (!confirm(`Tem certeza que deseja excluir ${selectedRows.length} quest√£o(√µes)?`)) {
                    return;
                }
                
                const ids = Array.from(selectedRows)
                    .map(row => row.dataset.id)
                    .filter(id => id);
                
                await this.deleteQuestions(ids);
                this.updateAllViews();
            }
        }

        // Inicializar aplica√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM Carregado - Iniciando aplica√ß√£o...');
            window.enemAnalyzer = new ENEMAnalyzer();
        });

        // Comandos de debug
        window.debugENEM = {
            showData: () => {
                console.log('üìä Dados atuais:', window.enemAnalyzer.questions);
                return window.enemAnalyzer.questions;
            },
            testSave: async () => {
                console.log('üß™ Testando salvamento...');
                const testQuestion = {
                    subject: 'TESTE',
                    topic: 'Persist√™ncia',
                    subtopic: 'Teste de sistema',
                    description: 'Esta √© uma quest√£o de teste',
                    erros: { conteudo: true, atencao: false, tempo: true }
                };
                
                const saved = await window.enemAnalyzer.saveQuestion(testQuestion);
                console.log('‚úÖ Teste conclu√≠do:', saved ? 'SUCESSO' : 'FALHA');
                return saved;
            }
        };
    </script>
</body>
</html>